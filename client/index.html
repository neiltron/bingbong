<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bingbong - Claude Code Audio Monitor</title>
        <style>
            /* ============================================
               Design Tokens
               ============================================ */
            :root {
                /* Colors - Background */
                --color-bg-base: #0a0a0f;
                --color-bg-surface: #12121a;
                --color-bg-elevated: #1a1a24;

                /* Colors - Border */
                --color-border: #2a2a3a;

                /* Colors - Text */
                --color-text-primary: #e0e0e0;
                --color-text-secondary: #999;
                --color-text-muted: #888;
                --color-text-inverse: #0a0a0f;
                --color-text-bright: #fff;

                /* Colors - Accent */
                --color-accent: #4ecdc4;
                --color-accent-hover: #5fd9d0;

                /* Colors - Semantic */
                --color-success: #44ff44;
                --color-error: #ff4444;
                --color-tool: #ff6b6b;

                /* Typography */
                --font-mono: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", monospace;
                --font-size-xs: 0.75em;
                --font-size-sm: 0.8em;
                --font-size-base: 0.85em;
                --font-size-md: 0.9em;
                --font-size-lg: 1.5em;

                /* Spacing */
                --space-xs: 8px;
                --space-sm: 10px;
                --space-md: 15px;
                --space-lg: 20px;

                /* Radii */
                --radius-sm: 4px;
                --radius-md: 8px;
                --radius-full: 50%;

                /* Transitions */
                --transition-fast: 0.2s ease;
                --transition-base: 0.3s ease;

                /* Layout */
                --sidebar-width: 300px;
                --container-max: 1400px;
                --visualizer-height: 400px;
            }

            /* ============================================
               Reset & Base
               ============================================ */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            :focus-visible {
                outline: 2px solid var(--color-accent);
                outline-offset: 2px;
            }

            @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }

            body {
                font-family: var(--font-mono);
                background: var(--color-bg-base);
                color: var(--color-text-primary);
                min-height: 100vh;
                overflow-x: hidden;
            }

            /* ============================================
               Accessibility
               ============================================ */
            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: var(--color-accent);
                color: var(--color-text-inverse);
                padding: var(--space-xs) var(--space-md);
                z-index: 100;
                text-decoration: none;
                font-size: 14px;
                border-radius: 0 0 var(--radius-sm) 0;
            }

            .skip-link:focus {
                top: 0;
            }

            /* ============================================
               Layout
               ============================================ */
            .container {
                max-width: var(--container-max);
                margin: 0 auto;
                padding: var(--space-lg);
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--space-lg) 0;
                border-bottom: 1px solid var(--color-border);
                margin-bottom: var(--space-lg);
            }

            .main-grid {
                display: grid;
                grid-template-columns: 1fr var(--sidebar-width);
                gap: var(--space-lg);
            }

            .sidebar {
                display: flex;
                flex-direction: column;
                gap: var(--space-lg);
            }

            @media (max-width: 900px) {
                .main-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* ============================================
               Typography
               ============================================ */
            h1 {
                font-size: var(--font-size-lg);
                font-weight: 400;
                color: var(--color-text-bright);
            }

            h1 span {
                color: var(--color-accent);
            }

            .panel h2 {
                font-size: var(--font-size-md);
                font-weight: 500;
                color: var(--color-text-muted);
                margin-bottom: var(--space-md);
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            /* ============================================
               Components - Status
               ============================================ */
            .status {
                display: flex;
                align-items: center;
                gap: var(--space-sm);
            }

            .status-dot {
                width: 10px;
                height: 10px;
                border-radius: var(--radius-full);
                background: var(--color-error);
                transition: background var(--transition-base);
            }

            .status-dot.connected {
                background: var(--color-success);
                box-shadow: 0 0 10px var(--color-success);
            }

            /* ============================================
               Components - Buttons
               ============================================ */
            .btn {
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-family: inherit;
                font-size: 14px;
                transition: background var(--transition-fast);
            }

            .btn:disabled {
                cursor: not-allowed;
            }

            #connect-btn {
                background: var(--color-accent);
                color: var(--color-text-inverse);
                padding: var(--space-sm) var(--space-lg);
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-family: inherit;
                font-size: 14px;
                transition: background var(--transition-fast);
            }

            #connect-btn:hover {
                background: var(--color-accent-hover);
            }

            #connect-btn:disabled {
                background: var(--color-bg-elevated);
                color: var(--color-text-muted);
                cursor: not-allowed;
            }

            .mute-btn {
                background: none;
                border: 1px solid var(--color-accent);
                color: var(--color-accent);
                padding: var(--space-xs) var(--space-md);
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-family: inherit;
                font-size: 12px;
                transition: all var(--transition-fast);
            }

            .mute-btn:hover {
                background: var(--color-accent);
                color: var(--color-text-inverse);
            }

            .mute-btn.muted {
                border-color: var(--color-error);
                color: var(--color-error);
            }

            /* ============================================
               Components - Panel
               ============================================ */
            .panel {
                background: var(--color-bg-surface);
                border-radius: var(--radius-md);
                padding: var(--space-md);
                border: 1px solid var(--color-border);
                contain: content;
            }

            /* ============================================
               Components - Visualizer
               ============================================ */
            .visualizer-section {
                background: var(--color-bg-surface);
                border-radius: var(--radius-md);
                padding: var(--space-lg);
                border: 1px solid var(--color-border);
                contain: layout paint;
            }

            #visualizer {
                display: block;
                width: 100%;
                height: var(--visualizer-height);
                background: var(--color-bg-base);
                border-radius: var(--radius-sm);
            }

            /* ============================================
               Components - Sessions
               ============================================ */
            .sessions-list {
                display: flex;
                flex-direction: column;
                gap: var(--space-sm);
            }

            .session-item {
                display: flex;
                align-items: center;
                gap: var(--space-sm);
                padding: var(--space-sm);
                background: var(--color-bg-elevated);
                border-radius: var(--radius-sm);
            }

            .session-color {
                width: 12px;
                height: 12px;
                border-radius: var(--radius-full);
                flex-shrink: 0;
            }

            .session-info {
                flex: 1;
                min-width: 0;
            }

            .session-id {
                font-size: var(--font-size-base);
                color: var(--color-text-bright);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .session-meta {
                font-size: var(--font-size-xs);
                color: var(--color-text-secondary);
            }

            .pan-indicator {
                width: 60px;
                height: 6px;
                background: var(--color-border);
                border-radius: 3px;
                position: relative;
            }

            .pan-dot {
                position: absolute;
                width: 8px;
                height: 8px;
                background: var(--color-accent);
                border-radius: var(--radius-full);
                top: -1px;
                transform: translateX(-50%);
            }

            /* ============================================
               Components - Event Log
               ============================================ */
            .event-log {
                max-height: 300px;
                overflow-y: auto;
                font-size: var(--font-size-sm);
            }

            .event-item {
                padding: var(--space-xs);
                border-bottom: 1px solid var(--color-bg-elevated);
                animation: fadeIn var(--transition-base);
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .event-type {
                color: var(--color-accent);
                font-weight: 500;
            }

            .event-tool {
                color: var(--color-tool);
            }

            .event-time {
                color: var(--color-text-secondary);
                font-size: var(--font-size-md);
            }

            /* ============================================
               Components - Controls
               ============================================ */
            .controls {
                display: flex;
                flex-direction: column;
                gap: var(--space-md);
            }

            .control-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .control-row label {
                font-size: var(--font-size-base);
                color: var(--color-text-muted);
            }

            input[type="range"] {
                width: 100px;
                accent-color: var(--color-accent);
            }

            /* ============================================
               Components - Empty State
               ============================================ */
            .empty-state {
                color: var(--color-text-muted);
                font-style: italic;
                text-align: center;
                padding: var(--space-lg);
            }
        </style>
    </head>
    <body>
        <a href="#main-content" class="skip-link">Skip to main content</a>
        <div class="container">
            <header>
                <h1><span>Bingbong</span> Claude Code</h1>
                <div class="status">
                    <div class="status-dot" id="status-dot" role="status" aria-label="Connection status: disconnected"></div>
                    <span id="status-text">Disconnected</span>
                    <button id="connect-btn">Connect</button>
                </div>
            </header>

            <main class="main-grid" id="main-content">
                <div class="visualizer-section">
                    <canvas id="visualizer" role="img" aria-label="Audio visualization showing particle effects for active Claude Code sessions">
                        <p>Visual representation of audio events from connected Claude Code sessions</p>
                    </canvas>
                </div>

                <aside class="sidebar" aria-label="Controls and session information">
                    <section class="panel" aria-labelledby="controls-heading">
                        <h2 id="controls-heading">Controls</h2>
                        <div class="controls">
                            <div class="control-row">
                                <label for="volume">Master Volume</label>
                                <input
                                    type="range"
                                    id="volume"
                                    min="0"
                                    max="100"
                                    value="70"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    aria-valuenow="70"
                                />
                            </div>
                            <div class="control-row">
                                <label for="reverb">Reverb</label>
                                <input
                                    type="range"
                                    id="reverb"
                                    min="0"
                                    max="100"
                                    value="30"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    aria-valuenow="30"
                                />
                            </div>
                            <button class="mute-btn" id="mute-btn" aria-pressed="false">Mute</button>
                        </div>
                    </section>

                    <section class="panel" aria-labelledby="sessions-heading">
                        <h2 id="sessions-heading">Active Sessions</h2>
                        <div class="sessions-list" id="sessions-list" role="list" aria-live="polite">
                            <div class="empty-state" role="listitem">No active sessions</div>
                        </div>
                    </section>

                    <section class="panel" aria-labelledby="eventlog-heading">
                        <h2 id="eventlog-heading">Event Log</h2>
                        <div class="event-log" id="event-log" role="log" aria-live="polite" aria-atomic="false">
                            <div class="empty-state">Waiting for events...</div>
                        </div>
                    </section>
                </aside>
            </main>
        </div>

        <script>
            // ============================================
            // Configuration
            // ============================================
            const WS_PORT = 3334;
            const WS_URL = `ws://${window.location.hostname || 'localhost'}:${WS_PORT}/ws`;

            // Helper to escape HTML for safe DOM insertion
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Helper to create elements safely
            function createElement(tag, attrs = {}, children = []) {
                const el = document.createElement(tag);
                for (const [key, value] of Object.entries(attrs)) {
                    if (key === 'style' && typeof value === 'object') {
                        Object.assign(el.style, value);
                    } else if (key.startsWith('data-')) {
                        el.dataset[key.slice(5)] = value;
                    } else {
                        el.setAttribute(key, value);
                    }
                }
                for (const child of children) {
                    if (typeof child === 'string') {
                        el.appendChild(document.createTextNode(child));
                    } else if (child) {
                        el.appendChild(child);
                    }
                }
                return el;
            }

            // Sound mappings - notes and characteristics for each event/tool
            const SOUND_CONFIG = {
                // Event types
                SessionStart: {
                    note: "C4",
                    duration: 0.4,
                    type: "sine",
                    gain: 0.4,
                },
                SessionEnd: {
                    note: "G3",
                    duration: 0.5,
                    type: "sine",
                    gain: 0.3,
                },
                Stop: {
                    notes: ["C5", "E5", "G5"],
                    duration: 0.6,
                    type: "sine",
                    gain: 0.5,
                },
                SubagentStop: {
                    note: "E5",
                    duration: 0.3,
                    type: "triangle",
                    gain: 0.35,
                },
                PreCompact: {
                    note: "D4",
                    duration: 0.2,
                    type: "sawtooth",
                    gain: 0.15,
                },

                // Tool-specific sounds (for PreToolUse/PostToolUse)
                tools: {
                    Read: {
                        note: "A4",
                        duration: 0.08,
                        type: "sine",
                        gain: 0.15,
                    },
                    Write: {
                        note: "E4",
                        duration: 0.12,
                        type: "triangle",
                        gain: 0.25,
                    },
                    Edit: {
                        note: "D4",
                        duration: 0.1,
                        type: "triangle",
                        gain: 0.2,
                    },
                    Bash: {
                        note: "F3",
                        duration: 0.15,
                        type: "square",
                        gain: 0.12,
                    },
                    Task: {
                        notes: ["G4", "B4"],
                        duration: 0.25,
                        type: "sine",
                        gain: 0.35,
                    },
                    Grep: {
                        note: "B4",
                        duration: 0.06,
                        type: "sine",
                        gain: 0.1,
                    },
                    Glob: {
                        note: "C5",
                        duration: 0.06,
                        type: "sine",
                        gain: 0.1,
                    },
                    WebFetch: {
                        note: "F#4",
                        duration: 0.15,
                        type: "sine",
                        gain: 0.2,
                    },
                    WebSearch: {
                        note: "G#4",
                        duration: 0.2,
                        type: "sine",
                        gain: 0.25,
                    },
                    TodoWrite: {
                        note: "A3",
                        duration: 0.1,
                        type: "triangle",
                        gain: 0.15,
                    },
                    default: {
                        note: "C4",
                        duration: 0.1,
                        type: "sine",
                        gain: 0.15,
                    },
                },
            };

            // Note to frequency mapping
            const NOTE_FREQ = {
                C3: 130.81,
                D3: 146.83,
                E3: 164.81,
                F3: 174.61,
                "F#3": 185.0,
                G3: 196.0,
                "G#3": 207.65,
                A3: 220.0,
                B3: 246.94,
                C4: 261.63,
                D4: 293.66,
                E4: 329.63,
                F4: 349.23,
                "F#4": 369.99,
                G4: 392.0,
                "G#4": 415.3,
                A4: 440.0,
                B4: 493.88,
                C5: 523.25,
                D5: 587.33,
                E5: 659.25,
                F5: 698.46,
                G5: 783.99,
                A5: 880.0,
                B5: 987.77,
            };

            // ============================================
            // Audio Engine
            // ============================================
            class AudioEngine {
                constructor() {
                    this.ctx = null;
                    this.masterGain = null;
                    this.convolver = null;
                    this.reverbGain = null;
                    this.dryGain = null;
                    this.muted = false;
                    this.volume = 0.7;
                    this.reverbAmount = 0.3;
                }

                async init() {
                    if (this.ctx) return;

                    this.ctx = new (
                        window.AudioContext || window.webkitAudioContext
                    )();

                    // Create master gain
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = this.volume;

                    // Create reverb path
                    this.convolver = this.ctx.createConvolver();
                    this.reverbGain = this.ctx.createGain();
                    this.reverbGain.gain.value = this.reverbAmount;

                    this.dryGain = this.ctx.createGain();
                    this.dryGain.gain.value = 1 - this.reverbAmount;

                    // Generate impulse response for reverb
                    await this.createReverbImpulse();

                    // Connect: source -> [dry + reverb] -> master -> output
                    this.convolver.connect(this.reverbGain);
                    this.reverbGain.connect(this.masterGain);
                    this.dryGain.connect(this.masterGain);
                    this.masterGain.connect(this.ctx.destination);
                }

                async createReverbImpulse() {
                    const duration = 2;
                    const decay = 2;
                    const sampleRate = this.ctx.sampleRate;
                    const length = sampleRate * duration;
                    const impulse = this.ctx.createBuffer(
                        2,
                        length,
                        sampleRate,
                    );

                    for (let channel = 0; channel < 2; channel++) {
                        const data = impulse.getChannelData(channel);
                        for (let i = 0; i < length; i++) {
                            data[i] =
                                (Math.random() * 2 - 1) *
                                Math.pow(1 - i / length, decay);
                        }
                    }

                    this.convolver.buffer = impulse;
                }

                setVolume(value) {
                    this.volume = value;
                    if (this.masterGain) {
                        this.masterGain.gain.value = this.muted ? 0 : value;
                    }
                }

                setReverb(value) {
                    this.reverbAmount = value;
                    if (this.reverbGain && this.dryGain) {
                        this.reverbGain.gain.value = value;
                        this.dryGain.gain.value = 1 - value * 0.5;
                    }
                }

                toggleMute() {
                    this.muted = !this.muted;
                    if (this.masterGain) {
                        this.masterGain.gain.value = this.muted
                            ? 0
                            : this.volume;
                    }
                    return this.muted;
                }

                playSound(config, pan = 0) {
                    if (!this.ctx || this.muted) return;

                    const now = this.ctx.currentTime;
                    const notes = config.notes || [config.note];

                    notes.forEach((note, i) => {
                        const freq = NOTE_FREQ[note] || 440;
                        const delay = i * 0.05; // Slight delay for chords

                        // Create oscillator
                        const osc = this.ctx.createOscillator();
                        osc.type = config.type || "sine";
                        osc.frequency.value = freq;

                        // Create gain for envelope
                        const gainNode = this.ctx.createGain();
                        gainNode.gain.value = 0;

                        // Create panner
                        const panner = this.ctx.createStereoPanner();
                        panner.pan.value = pan;

                        // Connect: osc -> gain -> panner -> [dry + convolver]
                        osc.connect(gainNode);
                        gainNode.connect(panner);
                        panner.connect(this.dryGain);
                        panner.connect(this.convolver);

                        // Envelope
                        const attackTime = 0.01;
                        const releaseTime = config.duration * 0.7;
                        const gain = config.gain || 0.2;

                        gainNode.gain.setValueAtTime(0, now + delay);
                        gainNode.gain.linearRampToValueAtTime(
                            gain,
                            now + delay + attackTime,
                        );
                        gainNode.gain.exponentialRampToValueAtTime(
                            0.001,
                            now + delay + config.duration,
                        );

                        // Start and stop
                        osc.start(now + delay);
                        osc.stop(now + delay + config.duration + 0.1);
                    });
                }

                playEvent(event) {
                    const { event_type, tool_name, pan } = event;

                    // Get sound config based on event type
                    let config;

                    if (
                        event_type === "PreToolUse" ||
                        event_type === "PostToolUse"
                    ) {
                        // Use tool-specific sound
                        config =
                            SOUND_CONFIG.tools[tool_name] ||
                            SOUND_CONFIG.tools.default;

                        // Make PostToolUse slightly different (higher pitch)
                        if (event_type === "PostToolUse" && config.note) {
                            const noteIndex = Object.keys(NOTE_FREQ).indexOf(
                                config.note,
                            );
                            if (noteIndex > 0) {
                                config = {
                                    ...config,
                                    note:
                                        Object.keys(NOTE_FREQ)[noteIndex + 1] ||
                                        config.note,
                                };
                            }
                        }
                    } else {
                        // Use event type sound
                        config =
                            SOUND_CONFIG[event_type] ||
                            SOUND_CONFIG.tools.default;
                    }

                    this.playSound(config, pan || 0);
                }
            }

            // ============================================
            // Visualizer
            // ============================================
            class Visualizer {
                constructor(canvas) {
                    this.canvas = canvas;
                    this.ctx = canvas.getContext("2d", { alpha: false });
                    this.particles = [];
                    this.sessions = new Map();
                    this.animationId = null;
                    this.isAnimating = false;
                    this.dpr = window.devicePixelRatio || 1;
                    this.resizeTimeout = null;

                    // Cache canvas dimensions
                    this.width = 0;
                    this.height = 400;

                    this.resize();
                    window.addEventListener("resize", () => this.throttledResize());
                }

                throttledResize() {
                    if (this.resizeTimeout) return;
                    this.resizeTimeout = setTimeout(() => {
                        this.resize();
                        this.resizeTimeout = null;
                    }, 100);
                }

                resize() {
                    // Get the canvas's own rendered width (respects CSS width: 100% and parent padding)
                    const rect = this.canvas.getBoundingClientRect();
                    this.width = rect.width;
                    this.dpr = window.devicePixelRatio || 1;

                    // Scale canvas for retina displays
                    this.canvas.width = this.width * this.dpr;
                    this.canvas.height = this.height * this.dpr;
                    this.ctx.scale(this.dpr, this.dpr);

                    // Redraw static elements after resize
                    this.drawStatic();
                }

                drawStatic() {
                    const { ctx } = this;

                    // Clear canvas
                    ctx.fillStyle = "#0a0a0f";
                    ctx.fillRect(0, 0, this.width, this.height);

                    // Draw center line
                    ctx.strokeStyle = "rgba(74, 74, 90, 0.3)";
                    ctx.beginPath();
                    ctx.moveTo(this.width / 2, 0);
                    ctx.lineTo(this.width / 2, this.height);
                    ctx.stroke();

                    // Draw L/R labels
                    ctx.fillStyle = "rgba(74, 74, 90, 0.5)";
                    ctx.font = "12px monospace";
                    ctx.fillText("L", 10, 20);
                    ctx.fillText("R", this.width - 20, 20);

                    // Draw session positions
                    for (const session of this.sessions.values()) {
                        const x = ((session.pan + 1) / 2) * this.width;
                        ctx.beginPath();
                        ctx.arc(x, this.height - 20, 5, 0, Math.PI * 2);
                        ctx.fillStyle = session.color;
                        ctx.fill();
                    }
                }

                addEvent(event) {
                    const { pan, color, event_type, tool_name } = event;

                    // Calculate x position from pan (-1 to 1 -> 0 to width)
                    const x = ((pan + 1) / 2) * this.width;
                    const y = this.height / 2;

                    // Particle properties based on event
                    let size = 20;
                    let lifetime = 60;

                    if (event_type === "Stop") {
                        size = 50;
                        lifetime = 120;
                    } else if (
                        event_type === "PreToolUse" ||
                        event_type === "PostToolUse"
                    ) {
                        size = tool_name === "Task" ? 35 : 15;
                        lifetime = 45;
                    }

                    this.particles.push({
                        x,
                        y,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        size,
                        color: color || "#4ECDC4",
                        alpha: 1,
                        lifetime,
                        maxLifetime: lifetime,
                    });

                    // Start animation if not running
                    if (!this.isAnimating) {
                        this.startAnimation();
                    }
                }

                updateSession(session) {
                    this.sessions.set(session.session_id, session);
                    // Redraw static elements to show new session
                    if (!this.isAnimating) {
                        this.drawStatic();
                    }
                }

                startAnimation() {
                    this.isAnimating = true;
                    this.animate();
                }

                stopAnimation() {
                    this.isAnimating = false;
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    // Draw final static state
                    this.drawStatic();
                }

                animate() {
                    if (!this.isAnimating) return;

                    const { ctx } = this;

                    // Clear with fade effect
                    ctx.fillStyle = "rgba(10, 10, 15, 0.15)";
                    ctx.fillRect(0, 0, this.width, this.height);

                    // Draw center line
                    ctx.strokeStyle = "rgba(74, 74, 90, 0.3)";
                    ctx.beginPath();
                    ctx.moveTo(this.width / 2, 0);
                    ctx.lineTo(this.width / 2, this.height);
                    ctx.stroke();

                    // Draw L/R labels
                    ctx.fillStyle = "rgba(74, 74, 90, 0.5)";
                    ctx.font = "12px monospace";
                    ctx.fillText("L", 10, 20);
                    ctx.fillText("R", this.width - 20, 20);

                    // Draw session positions
                    for (const session of this.sessions.values()) {
                        const x = ((session.pan + 1) / 2) * this.width;
                        ctx.beginPath();
                        ctx.arc(x, this.height - 20, 5, 0, Math.PI * 2);
                        ctx.fillStyle = session.color;
                        ctx.fill();
                    }

                    // Update and draw particles
                    let activeParticles = 0;
                    this.particles = this.particles.filter((p) => {
                        p.lifetime--;
                        if (p.lifetime <= 0) return false;

                        activeParticles++;
                        p.alpha = p.lifetime / p.maxLifetime;
                        p.x += p.vx;
                        p.y += p.vy;
                        p.size *= 0.98;

                        const alphaHex = Math.floor(p.alpha * 255).toString(16).padStart(2, "0");

                        // Glow effect (drawn first, behind main circle)
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size * 1.5, 0, Math.PI * 2);
                        ctx.fillStyle = p.color + Math.floor(p.alpha * 50).toString(16).padStart(2, "0");
                        ctx.fill();

                        // Main particle
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = p.color + alphaHex;
                        ctx.fill();

                        return true;
                    });

                    // Stop animation when no particles
                    if (activeParticles === 0) {
                        this.stopAnimation();
                        return;
                    }

                    this.animationId = requestAnimationFrame(() => this.animate());
                }
            }

            // ============================================
            // App State & UI
            // ============================================
            let ws = null;
            let audioEngine = new AudioEngine();
            let visualizer = null;
            const sessions = new Map();
            const eventLog = [];
            const MAX_LOG_ITEMS = 50;

            // Cached DOM references (populated on DOMContentLoaded)
            const DOM = {
                sessionsEl: null,
                logEl: null,
                connectBtn: null,
                statusDot: null,
                statusText: null,
                muteBtn: null,
                volumeInput: null,
                reverbInput: null
            };

            function updateUI() {
                // Update sessions list using safe DOM methods
                const sessionsEl = DOM.sessionsEl;
                sessionsEl.innerHTML = '';

                if (sessions.size === 0) {
                    sessionsEl.appendChild(
                        createElement('div', { class: 'empty-state', role: 'listitem' }, ['No active sessions'])
                    );
                } else {
                    for (const s of sessions.values()) {
                        const panPercent = ((s.pan + 1) / 2) * 100;
                        const sessionItem = createElement('div', { class: 'session-item', role: 'listitem' }, [
                            createElement('div', { class: 'session-color', style: { background: s.color }, 'aria-hidden': 'true' }),
                            createElement('div', { class: 'session-info' }, [
                                createElement('div', { class: 'session-id' }, [s.session_id.slice(0, 12) + '...']),
                                createElement('div', { class: 'session-meta' }, [
                                    `${s.machine_id || 'Unknown'} â€¢ ${s.event_count || 0} events`
                                ])
                            ]),
                            createElement('div', { class: 'pan-indicator', 'aria-label': `Pan position: ${Math.round(s.pan * 100)}%` }, [
                                createElement('div', { class: 'pan-dot', style: { left: `${panPercent}%`, background: s.color } })
                            ])
                        ]);
                        sessionsEl.appendChild(sessionItem);
                    }
                }

                // Update event log using safe DOM methods
                const logEl = DOM.logEl;
                logEl.innerHTML = '';

                if (eventLog.length === 0) {
                    logEl.appendChild(
                        createElement('div', { class: 'empty-state' }, ['Waiting for events...'])
                    );
                } else {
                    const recentEvents = eventLog.slice(-MAX_LOG_ITEMS).reverse();
                    for (const e of recentEvents) {
                        const eventChildren = [
                            createElement('span', { class: 'event-type' }, [e.event_type || 'Unknown'])
                        ];
                        if (e.tool_name) {
                            eventChildren.push(
                                createElement('span', { class: 'event-tool' }, [e.tool_name])
                            );
                        }
                        eventChildren.push(
                            createElement('span', { class: 'event-time' }, [
                                e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : ''
                            ])
                        );
                        logEl.appendChild(
                            createElement('div', { class: 'event-item' }, eventChildren)
                        );
                    }
                }
            }

            function handleEvent(event) {
                // Update session tracking
                if (event.session_id) {
                    sessions.set(event.session_id, {
                        session_id: event.session_id,
                        machine_id: event.machine_id,
                        pan: event.pan,
                        color: event.color,
                        event_count:
                            (sessions.get(event.session_id)?.event_count || 0) +
                            1,
                    });
                    visualizer?.updateSession(sessions.get(event.session_id));
                }

                // Add to log
                eventLog.push(event);
                if (eventLog.length > MAX_LOG_ITEMS * 2) {
                    eventLog.splice(0, MAX_LOG_ITEMS);
                }

                // Play sound
                audioEngine.playEvent(event);

                // Visualize
                visualizer?.addEvent(event);

                // Update UI
                updateUI();
            }

            let audioInitFailed = false;

            async function connect() {
                const { connectBtn: btn, statusDot: dot, statusText: text, muteBtn } = DOM;

                btn.disabled = true;
                btn.textContent = "Connecting...";
                dot.setAttribute('aria-label', 'Connection status: connecting');

                try {
                    // Initialize audio (requires user gesture)
                    try {
                        await audioEngine.init();
                        audioInitFailed = false;
                    } catch (audioErr) {
                        audioInitFailed = true;
                        // Continue without audio - show warning but don't block connection
                        muteBtn.textContent = "Audio unavailable";
                        muteBtn.disabled = true;
                        muteBtn.setAttribute('aria-disabled', 'true');
                    }

                    ws = new WebSocket(WS_URL);

                    ws.onopen = () => {
                        dot.classList.add("connected");
                        dot.setAttribute('aria-label', 'Connection status: connected');
                        text.textContent = audioInitFailed ? "Connected (no audio)" : "Connected";
                        btn.textContent = "Disconnect";
                        btn.disabled = false;
                    };

                    ws.onmessage = (msg) => {
                        try {
                            const data = JSON.parse(msg.data);

                            // Handle init message with existing sessions
                            if (data.type === "init" && data.sessions) {
                                data.sessions.forEach((s) => {
                                    sessions.set(s.session_id, s);
                                    visualizer?.updateSession(s);
                                });
                                updateUI();
                                return;
                            }

                            // Handle regular event
                            handleEvent(data);
                        } catch (err) {
                            // Silently handle parse errors for malformed messages
                        }
                    };

                    ws.onclose = () => {
                        dot.classList.remove("connected");
                        dot.setAttribute('aria-label', 'Connection status: disconnected');
                        text.textContent = "Disconnected";
                        btn.textContent = "Connect";
                        btn.disabled = false;
                        ws = null;
                    };

                    ws.onerror = () => {
                        dot.setAttribute('aria-label', 'Connection status: error');
                        text.textContent = "Connection failed";
                        btn.textContent = "Retry";
                        btn.disabled = false;
                    };
                } catch (err) {
                    dot.setAttribute('aria-label', 'Connection status: error');
                    text.textContent = "Connection failed";
                    btn.textContent = "Retry";
                    btn.disabled = false;
                }
            }

            function disconnect() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
            }

            // ============================================
            // Initialize
            // ============================================
            document.addEventListener("DOMContentLoaded", () => {
                // Cache DOM references
                DOM.sessionsEl = document.getElementById("sessions-list");
                DOM.logEl = document.getElementById("event-log");
                DOM.connectBtn = document.getElementById("connect-btn");
                DOM.statusDot = document.getElementById("status-dot");
                DOM.statusText = document.getElementById("status-text");
                DOM.muteBtn = document.getElementById("mute-btn");
                DOM.volumeInput = document.getElementById("volume");
                DOM.reverbInput = document.getElementById("reverb");

                // Initialize visualizer
                const canvas = document.getElementById("visualizer");
                visualizer = new Visualizer(canvas);

                // Connect button
                DOM.connectBtn.addEventListener("click", () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        disconnect();
                    } else {
                        connect();
                    }
                });

                // Volume control
                DOM.volumeInput.addEventListener("input", (e) => {
                    audioEngine.setVolume(e.target.value / 100);
                    e.target.setAttribute('aria-valuenow', e.target.value);
                });

                // Reverb control
                DOM.reverbInput.addEventListener("input", (e) => {
                    audioEngine.setReverb(e.target.value / 100);
                    e.target.setAttribute('aria-valuenow', e.target.value);
                });

                // Mute button
                DOM.muteBtn.addEventListener("click", (e) => {
                    const muted = audioEngine.toggleMute();
                    e.target.textContent = muted ? "Unmute" : "Mute";
                    e.target.classList.toggle("muted", muted);
                    e.target.setAttribute('aria-pressed', muted);
                });
            });
        </script>
    </body>
</html>
